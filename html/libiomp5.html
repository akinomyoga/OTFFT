<!DOCTYPE html PUBLIC "-//W3C//DTD html 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta name="description" content="OS X への GCC と Intel OpenMP Runtime の導入">
<meta name="keywords" content="AVX,Intel OpenMP,MacPorts,GCC">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="stockham.css" type="text/css">
<link rel="up" href="stockham.html">

<script type="text/javascript" src="ga.js"></script>

<title>OS X への GCC と Intel OpenMP Runtime の導入</title>
</head>
<body>
関連リンク：<a href="node4.html">OTFFT -- FFTW より速い FFT ライブラリ</a>
<hr>

<h1>OS X への GCC と Intel OpenMP Runtime の導入</h1>
<p>
　私は普段 Mac で <a href="node4.html">OTFFT</a> の開発等を行っています。
Mac は MacPorts などを使えば簡単に最新の GCC を導入できたりして便利なのですが、
AVX や AVX2 を使おうとするとそのままではエラーになってしまいます。
また、GCC の OpenMP はどうやら Linux に最適化されているようで、
OS X で GCC デフォルトの libgomp を使うと Linux ほど性能が出ません。
</p>
<p>
　そこで、このページでは OS X の GCC で AVX/AVX2 を使うための設定や、
OS X で libgomp より性能が上がる
<a href="https://www.openmprtl.org/download#stable-releases">Intel OpenMP Runtime</a>
の導入方について説明します。
</p>

<h2>【OS X の GCC で AVX/AVX2 を使う】</h2>
<p>
　OS X での GCC の導入自身は MacPorts を使えば説明するまでもなく簡単にできます。
問題は、コンパイルオプションに -march=native や -mtune=native をつけて、
AVX や AVX2 が使える CPU に対して最適化しようとするとエラーになることです。
これを回避するには以下の設定を行います。
</p>
<pre>
    cd /opt/local/bin
    sudo ln -s /usr/bin/clang
</pre>
<p>
　この設定をしてから g++ 等でコンパイルするとき
-Wa,-q オプションをつければエラーは出なくなります。
具体的には以下のようにします。
</p>
<pre>
    g++-mp-5 -Ofast -Wa,-q -march=native hello.cpp -o hello
</pre>

<h2>【OS X で Intel OpenMP Runtime  を使う】</h2>
<p>
　まずは、
<a href="https://www.openmprtl.org/download#stable-releases">こちらのページ</a>
から Intel OpenMP Runtime をダウンロードしておきましょう。
</p>
<p>
　次に、Intel OpenMP Runtime をビルドするために cmake をインストールします。
MacPorts にありますのでインストールしてください。続いて、
先ほどダウンロードした Intel OpenMP Runtime を展開したフォルダに移動して、
以下のコマンドを実行します。
</p>
<pre>
    cmake CMakeLists.txt
    make
</pre>
<p>
　たぶん正式には、この後 make install 等を行ってインストールするのでしょうが、
私は Mac のデフォルト環境をできるだけ汚したくないのでやりませんでした。
そこで、
手動で自分が開発のために準備したフォルダに必要なファイルを配置しました。
</p>
<p>
　ビルドされたライブラリ libiomp5.dylib は、
Intel OpenMP Runtime を展開したフォルダが $iomp5 だとすれば、
$iomp5/exports/mac_32e/lib.thin フォルダに入っています。
mac_32e の部分はアーキテクチャによって変化するようです。
その他、$iomp5/src にも入っています。
これを自分の使うフォルダへコピーしておきましょう。
私は $HOME/lib フォルダに配置しました。
このフォルダは魔法のフォルダです。
詳しくは man dyld の DYLD_FALLBACK_LIBRARY_PATH の説明を参照してください。
</p>
<p>
　OpenMP のヘッダファイルは、$iomp5/exports/common/include
に入っています。これも自分の使うフォルダへコピーしておきましょう。
これで GCC で libgomp の代わりに libiomp5 を使う準備が整いました。
</p>
<p>
　最後にコンパイル方についてですが、以下のように２段階でコンパイルします。
$iomp5include は Intel OpenMP Runtime のヘッダファイルを配置したフォルダです。
</p>
<pre>
    g++-mp-5 -Ofast -fopenmp -I$iomp5include -c hello.cpp
    g++-mp-5 hello.o -L$HOME/lib -liomp5 -o hello
</pre>
<p>
　余談ですが、Intel OpenMP Runtime は OS X の場合、
デフォルトでは clang でビルドされます。GCC でビルドしたい場合は、
cmake コマンドを実行するとき以下のようにします。
</p>
<pre>
    cmake -DCMAKE_C_COMPILER=gcc-mp-5 -DCMAKE_CXX_COMPILER=g++-mp-5 CMakeLists.txt
</pre>
<p>
　また、コンパイルオプションを変更したい場合などは ccmake コマンドを使います。
以下のようにします。
</p>
<pre>
    ccmake .
</pre>

<hr>
関連リンク：<a href="node4.html">OTFFT -- FFTW より速い FFT ライブラリ</a>
</body>
</html>
